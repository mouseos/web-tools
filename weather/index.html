<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>気象情報</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .editor {
            height: 60vh;
            width: 100%;
            overflow-y: auto;
        }

        body,
        html {
            height: 100vh;
        }

        main {
            height: 100%;
        }

        iframe {
            height: 50vh;
        }
    </style>
</head>

<body>
    <div class="navbar-fixed">
        <nav>
            <div class="nav-wrapper teal darken-1">
                <a href="#">気象情報</a>
                <a href="#" data-target="mobile-nav" class="sidenav-trigger"><i class="material-icons">menu</i></a>
                <ul id="pc-nav" class="right hide-on-med-and-down">
                    <li><a href="../index.html">他のツール</a></li>
                </ul>
            </div>
        </nav>
    </div>
    <ul class="sidenav" id="mobile-nav">

    </ul>
    <main>
        <div class="container">
            <h4 id="location-name"></h4>
            <div class="row" id="weather-cards"></div>
            <div class="row" id="weather-summary"></div>
        </div>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const elems = document.querySelectorAll('.sidenav');
            M.Sidenav.init(elems);
        });

        document.querySelector("#mobile-nav").innerHTML = document.querySelector("#pc-nav").innerHTML;

        // 天気情報の取得
        const regionId = '400040';
        const apiUrl = `https://weather.tsukumijima.net/api/forecast/city/${regionId}`;
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                // 地域名の表示
                const locationName = data.location.prefecture + ' ' + data.location.city;
                document.querySelector("#location-name").textContent = locationName;

                // 天気カードの表示
                const weatherCards = document.querySelector("#weather-cards");
                data.forecasts.forEach(forecast => {
                    const card = document.createElement("div");
                    card.className = "col s12 m6";
                    const cardContent = `
                        <div class="card">
                            <div class="card-content">
                                <span class="card-title">${forecast.dateLabel}</span>
                                <img src="${forecast.image.url}" alt="${forecast.telop}">
                                <p>${forecast.telop}</p>
                                <p>最低気温: ${forecast.temperature.min.celsius}℃</p>
                                <p>最高気温: ${forecast.temperature.max.celsius}℃</p>
                            </div>
                            <div class="card-action">
                                <canvas id="chart-${forecast.date}"></canvas>
                            </div>
                        </div>
                    `;
                    card.innerHTML = cardContent;
                    weatherCards.appendChild(card);

                    // 折れ線グラフの描画
                    const chartData = {
                        labels: ["00-06", "06-12", "12-18", "18-24"],
                        datasets: [{
                            label: "降水確率",
                            fill: false,
                            borderColor: "teal",
                            data: [
                                parseInt(forecast.chanceOfRain.T00_06) || 0,
                                parseInt(forecast.chanceOfRain.T06_12) || 0,
                                parseInt(forecast.chanceOfRain.T12_18) || 0,
                                parseInt(forecast.chanceOfRain.T18_24) || 0
                            ]
                        }]
                    };

                    const ctx = document.getElementById(`chart-${forecast.date}`).getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    suggestedMin: 0,
                                    suggestedMax: 100
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return context.parsed.y + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                });

                // 気象概況の表示
                const weatherSummary = document.querySelector("#weather-summary");
                const summaryCard = document.createElement("div");
                summaryCard.className = "col s12";
                const summaryCardContent = `
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">気象概況</span>
                            <p>${data.description.text}</p>
                        </div>
                    </div>
                `;
                summaryCard.innerHTML = summaryCardContent;
                weatherSummary.appendChild(summaryCard);
            });
    </script>
</body>

</html>